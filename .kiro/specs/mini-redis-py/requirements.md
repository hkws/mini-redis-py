# 要件定義書

## はじめに
Mini-Redisは、60〜90分のワークショップでPython/asyncioを使用してRedisの基本機能を実装する学習プロジェクトです。本プロジェクトでは、RESP（REdis Serialization Protocol）の理解、asyncioによるTCPサーバの実装、および基本的なRedisコマンド（PING/GET/SET/INCR）と発展的なEXPIREコマンドの実装を通じて、Redisの内部動作を学ぶことを目的としています。

## 要件

### 要件1: asyncioによるTCPサーバの実装
**目的:** 学習者として、asyncioを使用したTCPサーバを実装することで、非同期I/Oの基礎を理解したい

#### 受入基準

1. WHEN Mini-Redisサーバーが起動するとき、THEN システムは指定されたポート（デフォルト6379）でTCP接続を待ち受けなければならない
2. WHEN クライアントがサーバーに接続するとき、THEN Mini-Redisはasyncioを使用して接続を受け入れなければならない
3. WHILE クライアントが接続している間、THE Mini-Redisはメッセージを受信→解釈→コマンド実行→応答のループを実行しなければならない
4. WHEN クライアントが接続を切断するとき、THEN Mini-Redisはセッションを適切にクローズしなければならない
5. WHEN 複数のクライアントが接続するとき、THEN Mini-Redisは各クライアントのリクエストを並行処理できなければならない

### 要件2: RESPプロトコルのパース処理
**目的:** 学習者として、RESPプロトコルを実装することで、Redisの通信フォーマットを理解したい

#### 受入基準

1. WHEN クライアントがRESP形式のArraysメッセージを送信するとき、THEN Mini-RedisはArraysの要素数を正しく解析しなければならない
2. WHEN クライアントがRESP形式のBulk Stringsメッセージを送信するとき、THEN Mini-Redisは長さ指定に従ってデータ本体を読み取らなければならない
3. WHEN メッセージがCRLF（`\r\n`）で終端されているとき、THEN Mini-Redisはストリームから正しく1行を切り出さなければならない
4. WHEN クライアントがコマンドを送信するとき、THEN Mini-Redisはパースした結果をコマンド名と引数のリストに変換しなければならない
5. WHEN クライアントにレスポンスを返すとき、THEN Mini-RedisはRESP形式（Simple Strings、Integers、Bulk Strings、Errorsのいずれか）でエンコードしなければならない

### 要件3: 基本コマンドの実装（PING/GET/SET/INCR）
**目的:** 学習者として、基本的なRedisコマンドを実装することで、キー・バリューストアの動作原理を理解したい

#### 受入基準

1. WHEN クライアントがPINGコマンドを送信するとき、THEN Mini-Redisは`PONG`を返さなければならない
2. WHEN クライアントがSETコマンドでキーと文字列値を指定するとき、THEN Mini-Redisはそのキーと値をメモリ（辞書）に保存しなければならない
3. WHEN クライアントが既存のキーに対してGETコマンドを実行するとき、THEN Mini-Redisは保存されている値を返さなければならない
4. WHEN クライアントが存在しないキーに対してGETコマンドを実行するとき、THEN Mini-RedisはNull Bulk String（`$-1\r\n`）を返さなければならない
5. WHEN クライアントがINCRコマンドで既存の整数値のキーを指定するとき、THEN Mini-Redisは値を1増加させて新しい値を返さなければならない
6. WHEN クライアントがINCRコマンドで存在しないキーを指定するとき、THEN Mini-Redisはキーを作成し値を1に設定して1を返さなければならない
7. WHEN クライアントがINCRコマンドで整数でない値のキーを指定するとき、THEN Mini-Redisは型エラーメッセージを返さなければならない
8. WHEN redis-cliコマンドでMini-Redisに接続するとき、THEN 上記のすべてのコマンドが正常に動作しなければならない

### 要件4: 学習者向け実装雛形の提供
**目的:** ワークショップ主催者として、学習者がスムーズに実装を開始できるように、実装の雛形を提供したい

#### 受入基準

1. WHEN ワークショップが開始されるとき、THEN システムは学習者が実装を開始できる雛形コードを提供しなければならない
2. WHEN 学習者が雛形コードを開くとき、THEN 各モジュール（RESPパーサ、TCPサーバ、コマンドハンドラ）のスケルトンコードが含まれていなければならない
3. WHEN 学習者がクラスやメソッドを確認するとき、THEN 各メソッドにはTODOコメントと実装のヒントが記載されていなければならない
4. WHEN 学習者が実装を進めるとき、THEN 雛形には段階的に実装できるようにコメントで実装順序のガイドが含まれていなければならない
5. WHEN ワークショップで自動テストを使用するとき、THEN テストファイルが雛形に含まれており、実装の進捗を確認できなければならない
6. WHERE 学習者がPythonの環境を構築するとき、THEN 必要な依存関係（本体とpytest/mypy/ruffなどの開発用ツール）と対応Pythonバージョンを記載したpyproject.tomlが提供されなければならない

### 要件5: EXPIRE機能の実装（発展的内容）
**目的:** 学習者として、EXPIREコマンドを実装することで、Redisの期限管理メカニズム（passive + active方式）を理解したい

#### 受入基準

1. WHEN クライアントがEXPIREコマンドでキーと秒数を指定するとき、THEN Mini-Redisはそのキーに有効期限（Unix時刻）を設定しなければならない
2. WHEN クライアントが期限切れのキーに対してGET/SET/INCRコマンドを実行するとき（passive）、THEN Mini-Redisはアクセス時に期限を確認し、期限切れの場合はキーを削除してから処理しなければならない
3. WHILE Mini-Redisが稼働している間（active）、THE システムは定期的にバックグラウンドタスクを実行し、ランダムサンプリングで期限切れキーをチェックして削除しなければならない
4. WHEN クライアントが有効期限付きキーに対してTTLコマンドを実行するとき、THEN Mini-Redisは残り有効秒数を返さなければならない
5. WHEN クライアントが有効期限なしのキーに対してTTLコマンドを実行するとき、THEN Mini-Redisは-1を返さなければならない
6. WHEN クライアントが存在しないキーに対してTTLコマンドを実行するとき、THEN Mini-Redisは-2を返さなければならない

## 実装範囲外の項目

以下の項目はワークショップの範囲外とし、実装しません：
- List型、Hash型、Set型などの複雑なデータ構造
- データの永続化（RDB、AOF）
- DEL、EXISTS、PERSISTなどの追加コマンド
- 複雑なエラーハンドリング（基本的な型エラーのみ対応）
- 認証やセキュリティ機能
