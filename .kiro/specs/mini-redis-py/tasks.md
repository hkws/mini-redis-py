# 実装タスク

## 概要
本タスクリストは、Mini-Redisプロジェクトの実装計画を段階的に示します。各タスクは独立してテスト可能で、順次実装することで最終的に動作するRedisクローンが完成します。

---

## タスク一覧

- [x] 1. プロジェクトの基盤構築
- [x] 1.1 パッケージ設定とプロジェクト構造の初期化
  - Python 3.12以上を要求するpyproject.tomlを作成
  - 本体の依存関係を最小限に保つ（標準ライブラリ中心）
  - 開発用ツール（pytest、mypy、ruff）をオプショナル依存として定義
  - pytest、mypy、ruffの設定をpyproject.tomlに統合
  - プロジェクトのディレクトリ構造（mini_redis/モジュール配置）を作成
  - _Requirements: 4.6_

- [x] 1.2 基本的なモジュール構成の準備
  - ネットワーク層、プロトコル層、コマンド層、ストレージ層のスケルトンファイルを作成
  - 各モジュールにクラス定義のプレースホルダーを配置
  - 型ヒント用のインポート文を追加
  - _Requirements: 4.1, 4.2_

- [x] 2. RESPプロトコル実装
- [x] 2.1 RESPプロトコルのパース機能実装
  - StreamReaderを使用してバイト列を読み取る仕組みを実装
  - RESP Arrays（`*N\r\n`）の解析ロジックを実装
  - Bulk Strings（`$N\r\n...data...\r\n`）の解析ロジックを実装
  - CRLFによる行終端の処理を正確に実装
  - パース結果をコマンド名と引数リストに変換
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 2.2 RESPエンコーディング機能実装
  - Simple Strings（`+...\r\n`）のエンコード実装
  - Integers（`:N\r\n`）のエンコード実装
  - Bulk Strings（`$N\r\n...data...\r\n`）のエンコード実装
  - Null Bulk String（`$-1\r\n`）のエンコード実装
  - Errors（`-ERR ...\r\n`）のエンコード実装
  - _Requirements: 2.5_

- [x] 2.3 プロトコルエラー処理の追加
  - 不正なRESP形式の検出と例外送出
  - 接続切断時の適切なエラーハンドリング
  - メッセージサイズ制限の実装（例: 1MB上限）
  - _Requirements: 2.1-2.5, セキュリティ考慮事項_

- [x] 3. データストレージ層の実装
- [x] 3.1 基本的なキー・バリューストアの実装
  - インメモリ辞書を使用したデータ保存機能の実装
  - キーの取得（get）、設定（set）、削除（delete）メソッドの実装
  - キーの存在確認（exists）メソッドの実装
  - StoreEntryデータクラスでキー・値・有効期限を管理
  - _Requirements: 3.2_

- [x] 3.2 有効期限管理機能の追加
  - 各キーに有効期限（Unix timestamp）を設定する機能の実装
  - 有効期限の取得機能の実装
  - 有効期限の削除（期限なしに戻す）機能の実装
  - すべてのキーを取得する機能（Active expiry用）の実装
  - _Requirements: 5.1_

- [ ] 4. コマンド実行層の実装
- [ ] 4.1 コマンドハンドラの基本構造実装
  - コマンド名から適切なメソッドへのルーティング機能の実装
  - 未知のコマンドに対するエラーメッセージの返却
  - コマンド引数の数と型の検証ロジックの実装
  - _Requirements: 3.1-3.8_

- [ ] 4.2 基本コマンドの実装（PING/GET/SET）
  - PINGコマンド：常に"PONG"を返す機能の実装
  - GETコマンド：キーから値を取得し、存在しない場合はNull Bulk Stringを返す機能の実装
  - SETコマンド：キーと値を保存し、既存の有効期限をクリアする機能の実装
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 4.3 INCRコマンドの実装
  - キーが存在しない場合に1を設定する機能の実装
  - 既存の整数値を1増加させる機能の実装
  - 値が整数でない場合に型エラーを返す機能の実装
  - 増加後の新しい値を返す機能の実装
  - _Requirements: 3.5, 3.6, 3.7_

- [ ] 4.4 有効期限関連コマンドの実装（EXPIRE/TTL）
  - EXPIREコマンド：キーに指定秒数後の有効期限を設定する機能の実装
  - 存在しないキーに対してEXPIREが0を返す処理の実装
  - TTLコマンド：残り有効秒数を返す機能の実装
  - 有効期限なしキーに対してTTLが-1を返す処理の実装
  - 存在しないキーに対してTTLが-2を返す処理の実装
  - _Requirements: 5.1, 5.4, 5.5, 5.6_

- [ ] 5. ネットワーク層の実装
- [ ] 5.1 TCPサーバの基本実装
  - asyncio.start_serverを使用した接続待ち受け機能の実装
  - 指定ポート（デフォルト6379）でのリスニング機能の実装
  - サーバの起動と停止のライフサイクル管理機能の実装
  - Ctrl+Cによるグレースフルシャットダウンの実装
  - _Requirements: 1.1, 1.2_

- [ ] 5.2 クライアント接続処理の実装
  - クライアント接続ごとのハンドラタスク起動機能の実装
  - StreamReader/StreamWriterを使用したデータ送受信機能の実装
  - コマンドの読み取り→パース→実行→応答のループ実装
  - 接続切断時の適切なクリーンアップ処理の実装
  - _Requirements: 1.2, 1.3, 1.4_

- [ ] 5.3 複数クライアントの並行処理実装
  - TaskGroupを使用した構造化並行性の実装
  - 各クライアント接続を独立したタスクとして管理
  - 複数クライアントのリクエストを並行処理する機能の実装
  - _Requirements: 1.5_

- [ ] 6. 有効期限管理機能の実装
- [ ] 6.1 Passive Expiryの実装
  - キーアクセス時に有効期限をチェックする機能の実装
  - 期限切れの場合にキーを削除する機能の実装
  - ExpiryManagerクラスでcheck_and_remove_expiredメソッドの実装
  - _Requirements: 5.2_

- [ ] 6.2 Active Expiryバックグラウンドタスクの実装
  - 1秒ごとに実行されるバックグラウンドタスクの実装
  - ランダムに最大20キーをサンプリングする機能の実装
  - 期限切れキーを検出して削除する機能の実装
  - 削除率が25%を超える場合に即座に再実行するループロジックの実装
  - _Requirements: 5.3_

- [ ] 6.3 コマンド層へのPassive Expiry統合
  - GETコマンド実行前にcheck_and_remove_expiredを呼び出す処理の追加
  - INCRコマンド実行前にcheck_and_remove_expiredを呼び出す処理の追加
  - EXPIREコマンド実行前にcheck_and_remove_expiredを呼び出す処理の追加
  - TTLコマンド実行前にcheck_and_remove_expiredを呼び出す処理の追加
  - _Requirements: 5.2_

- [ ] 7. 学習者向け実装雛形の作成
- [ ] 7.1 実装ガイドとヒントの追加
  - 各メソッドにTODOコメントを追加
  - 実装のヒントをコメントで記載
  - 実装順序のガイドをドキュメントコメントに追加
  - _Requirements: 4.3, 4.4_

- [ ] 7.2 段階的実装ガイドの作成
  - 初心者が順番に実装できるようコメントで手順を明記
  - 各ステップでの期待される動作を説明
  - デバッグのヒントやよくある間違いを記載
  - _Requirements: 4.4_

- [ ] 8. テストスイートの実装
- [ ] 8.1 RESPプロトコルのユニットテスト実装
  - Arrays、Bulk Strings、Simple Stringsのパース正常系テスト
  - 不正フォーマット、CRLF欠如、長さ不一致の異常系テスト
  - 各エンコード関数（Simple String、Integer、Bulk String、Error）のテスト
  - Null Bulk Stringのエンコードテスト
  - _Requirements: 4.5_

- [ ] 8.2 DataStoreのユニットテスト実装
  - get/set/delete/existsメソッドの動作確認テスト
  - 有効期限設定（set_expiry/get_expiry）の正確性テスト
  - 存在しないキーの操作、上書き動作のテスト
  - _Requirements: 4.5_

- [ ] 8.3 ExpiryManagerのユニットテスト実装
  - Passive expiry（期限切れキー削除、有効キーは保持）のテスト
  - Active expiryのランダムサンプリング動作テスト
  - 削除率に応じた再実行ロジックのテスト
  - _Requirements: 4.5_

- [ ] 8.4 CommandHandlerのユニットテスト実装
  - 各コマンド（PING/GET/SET/INCR/EXPIRE/TTL）の正常系テスト
  - 引数不足、型エラー、未知のコマンドのエラーケーステスト
  - Passive expiryとコマンド実行の統合テスト
  - _Requirements: 4.5_

- [ ] 8.5 統合テストとE2Eテストの実装
  - TCPサーバとRESPパーサの統合テスト（実際のTCP接続）
  - SET→GET、INCR→GET、EXPIRE→GET→TTLの一貫性テスト
  - redis-cliを使用した実際の接続と動作確認テスト
  - 複数クライアント同時接続の並行処理テスト
  - _Requirements: 3.8, 4.5_

- [ ] 9. システム統合と動作検証
- [ ] 9.1 全コンポーネントの統合
  - すべてのレイヤー（ネットワーク、プロトコル、コマンド、ストレージ）を接続
  - サーバのメインエントリポイント（CLI起動スクリプト）の実装
  - Active Expiryバックグラウンドタスクの起動統合
  - _Requirements: 1.1-1.5, 3.8_

- [ ] 9.2 redis-cliでの動作確認
  - サーバを起動してredis-cliで接続
  - PING、GET、SET、INCRコマンドの動作確認
  - EXPIRE、TTLコマンドの動作確認
  - 複数クライアントの並行動作確認
  - _Requirements: 3.8_

- [ ] 9.3 エラーハンドリングとロギングの実装
  - 各レイヤーでの例外処理の追加
  - Python標準loggingモジュールを使用したログ出力の実装
  - サーバ起動/停止、クライアント接続/切断のログ記録
  - RESPプロトコルエラー、コマンド実行エラーのログ記録
  - _Requirements: すべての要件の堅牢性向上_

---

## 実装順序のガイドライン

1. **基盤から順に構築**: プロジェクト設定 → プロトコル → ストレージ → コマンド → ネットワーク
2. **段階的にテスト**: 各タスク完了後にユニットテストを実行して動作確認
3. **統合を早期に実施**: 個別コンポーネントが完成したら、統合テストで接続を確認
4. **redis-cliで検証**: 最後にredis-cliで実際の動作を確認し、すべてのコマンドが正しく動作することを確認

---

## 完了条件

すべてのタスクが完了し、以下の条件を満たすこと：
- ✅ すべてのユニットテストがパス
- ✅ 統合テストがパス
- ✅ redis-cliで接続し、PING/GET/SET/INCR/EXPIRE/TTLが動作
- ✅ 複数クライアントの並行接続が動作
- ✅ Passive/Active Expiryが正しく機能
- ✅ 学習者向けTODOコメントと実装ガイドが完備
